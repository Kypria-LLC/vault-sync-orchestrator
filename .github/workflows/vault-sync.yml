name: Vault Sync Pipeline

on:
#   schedule:
#       # Run every 6 hours
    #   - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      forcefirstrun:
        description: 'Force first-run ingestion (ignore existing state)'
        required: false
        type: boolean
        default: false

jobs:
  vault-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: write
      actions: read
      issues: write
    
    concurrency:
      group: vault-sync-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Vault CLI
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install vault

                  - name: Login to Vault (AppRole)
      id: vault_login
      env:
        VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        VAULT_ROLE_ID: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
        VAULT_SECRET_ID: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
        VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}
      run: |
        set -euo pipefail
        
        # Authenticate with AppRole
        resp=$(curl -s --request POST \
          --header "X-Vault-Namespace: $VAULT_NAMESPACE" \
          --data '{"role_id":"'$VAULT_ROLE_ID'","secret_id":"'$VAULT_SECRET_ID'"}' \
          ${VAULT_ADDR}/v1/auth/approle/login)
        
        token=$(echo "$resp" | jq -r '.auth.client_token // empty')
        
        if [ -z "$token" ]; then
          echo "Vault AppRole login failed: $resp" >&2
          exit 1
        fi
        
        # Export token to subsequent steps
        echo "VAULT_TOKEN=$token" >> $GITHUB_ENV
        echo "::add-mask::$token"Configure Vault authentication
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
#           VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}
        run: |
          export VAULT_ADDR=${{ secrets.VAULT_ADDR }}
          echo "Vault configured for $VAULT_ADDR"
          vault status || true
      
      - name: Force first-run if requested
        if: ${{ github.event.inputs.forcefirstrun == 'true' }}
        run: |
          echo "Forcing first-run ingestion"
          rm -f orchestrator/state/firstrun.flag
      
      - name: Create directory structure
        run: |
          mkdir -p orchestrator/state
          mkdir -p envs metadata inventories logs
          touch logs/audit.log
      
      - name: Execute vault-sync orchestrator
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
#           VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}
          VAULT_SECRET_PATHS: ${{ secrets.VAULT_SECRET_PATHS }}
        run: |
          chmod +x orchestrator/vault-sync.sh
          ./orchestrator/vault-sync.sh
      
      - name: Verify manifest integrity
        run: |
          if [ -f orchestrator/verify-state.sh ]; then
            chmod +x orchestrator/verify-state.sh
            ./orchestrator/verify-state.sh
          else
            echo "Verification script not found, skipping..."
          fi
      
      - name: Upload ceremony artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vault-sync-artifacts-${{ github.run_number }}
          path: |
            logs/ceremony-*.log
            manifest.json
            inventories/
            metadata/
          retention-days: 30
      
      - name: Commit ceremony results
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add logs/audit.log
          git commit -m "[Automated] Vault sync ceremony - $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes to commit"
          git push

  security-scan:
    runs-on: ubuntu-latest
    needs: vault-sync
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Scan for exposed secrets
        run: |
          echo "Scanning for potentially exposed secrets..."
          if grep -rE 'password|secret|key|token.{0,20}[A-Za-z0-9]{16,}' envs/ 2>/dev/null; then
            echo "::error::Potential secrets detected in envs/ directory"
            exit 1
          fi
          echo "No obvious secrets detected"
      
      - name: Validate file permissions
        run: |
          echo "Checking file permissions..."
          if find envs metadata -type f \( -perm /o+r -o -perm /g+r \) 2>/dev/null | grep -q .; then
            echo "::error::World or group readable files detected"
            exit 1
          fi
          echo "File permissions OK"
      
      - name: Create security issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security Scan Failure - Vault Sync Pipeline',
              body: `Security scan failed during vault-sync workflow run #${context.runNumber}.\n\nPlease review the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) immediately.`,
              labels: ['security', 'automated']
            })
